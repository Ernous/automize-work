# Инструкции по деплою на Render

## Подготовка к деплою

### 1. Подготовка репозитория

Убедитесь, что ваш репозиторий содержит все необходимые файлы:
- `Dockerfile` - для контейнеризации
- `render.yaml` - конфигурация Render
- `shard.yml` - зависимости Crystal
- Все исходные файлы в папке `src/`

### 2. Настройка переменных окружения

В Render вам нужно будет настроить следующие переменные окружения:

#### Обязательные переменные:
- `GEMINI_API_KEY` - API ключ Google Gemini
- `TELEGRAM_BOT_TOKEN` - токен Telegram бота
- `TELEGRAM_CHANNEL_ID` - ID канала Telegram
- `SESSION_SECRET` - секретный ключ для сессий (генерируется автоматически)

#### Опциональные переменные:
- `PORT` - порт приложения (по умолчанию 3000)
- `KEMAL_ENV` - окружение (production/development)

## Пошаговый деплой

### Шаг 1: Создание аккаунта на Render

1. Перейдите на [render.com](https://render.com)
2. Зарегистрируйтесь или войдите в аккаунт
3. Подтвердите email

### Шаг 2: Подключение репозитория

1. В Dashboard нажмите "New +"
2. Выберите "Web Service"
3. Подключите ваш Git репозиторий (GitHub, GitLab, Bitbucket)
4. Выберите репозиторий с проектом

### Шаг 3: Настройка сервиса

1. **Name**: `git-commit-telegram-bot` (или любое другое)
2. **Environment**: `Docker`
3. **Region**: выберите ближайший к вам регион
4. **Branch**: `main` (или ваша основная ветка)
5. **Root Directory**: оставьте пустым (если проект в корне)

### Шаг 4: Настройка переменных окружения

В разделе "Environment Variables" добавьте:

```
GEMINI_API_KEY = ваш_ключ_gemini
TELEGRAM_BOT_TOKEN = ваш_токен_бота
TELEGRAM_CHANNEL_ID = ваш_id_канала
SESSION_SECRET = сгенерированный_секрет
```

### Шаг 5: Запуск деплоя

1. Нажмите "Create Web Service"
2. Render автоматически начнет сборку и деплой
3. Дождитесь завершения (обычно 5-10 минут)

### Шаг 6: Получение URL

После успешного деплоя вы получите URL вида:
`https://your-app-name.onrender.com`

## Настройка вебхуков

### GitLab

1. Перейдите в настройки репозитория
2. Выберите "Webhooks"
3. Добавьте новый вебхук:
   - **URL**: `https://your-app-name.onrender.com/webhook/gitlab`
   - **Secret Token**: (опционально)
   - **Triggers**: выберите "Push events"
   - **SSL verification**: включите

### Forgejo/Gitea

1. Перейдите в настройки репозитория
2. Выберите "Webhooks"
3. Добавьте новый вебхук:
   - **Target URL**: `https://your-app-name.onrender.com/webhook/forgejo`
   - **HTTP Method**: POST
   - **Post Content Type**: application/json
   - **Triggers**: выберите "Push Events"

## Проверка работы

### 1. Проверка веб-интерфейса

1. Откройте URL вашего приложения
2. Зарегистрируйте первого пользователя
3. Настройте API ключи
4. Добавьте репозитории

### 2. Тестирование вебхуков

1. Сделайте коммит в один из подключенных репозиториев
2. Проверьте логи в Render Dashboard
3. Убедитесь, что пост появился в Telegram канале

### 3. Мониторинг

В Render Dashboard вы можете:
- Просматривать логи приложения
- Мониторить использование ресурсов
- Настраивать автоматические перезапуски

## Устранение проблем

### Проблема: Приложение не запускается

**Решение:**
1. Проверьте логи в Render Dashboard
2. Убедитесь, что все переменные окружения настроены
3. Проверьте, что Dockerfile корректен

### Проблема: Вебхуки не работают

**Решение:**
1. Проверьте URL вебхука (должен быть публично доступен)
2. Убедитесь, что репозиторий добавлен в приложение
3. Проверьте логи приложения на наличие ошибок

### Проблема: Посты не отправляются в Telegram

**Решение:**
1. Проверьте правильность токена бота
2. Убедитесь, что бот добавлен в канал как администратор
3. Проверьте ID канала (должен начинаться с `-100`)

## Обновление приложения

Для обновления приложения:
1. Внесите изменения в код
2. Закоммитьте и запушьте в репозиторий
3. Render автоматически пересоберет и перезапустит приложение

## Масштабирование

Render автоматически масштабирует приложение в зависимости от нагрузки. Для более серьезных нагрузок рассмотрите:
- Увеличение плана (Starter → Standard → Pro)
- Настройку автомасштабирования
- Использование CDN для статических файлов